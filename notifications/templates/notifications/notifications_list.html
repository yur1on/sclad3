{% extends 'warehouse/base.html' %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Roboto', sans-serif;
        background-color: #f4f6f9;
    }
    .notifications-wrapper {
        max-width: 1000px;
        margin: 20px auto;
        padding: 20px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .notifications-header {
        font-size: 24px;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 20px;
    }
    .notification-form {
        margin-bottom: 20px;
    }
    .notification-form label {
        font-size: 16px;
        color: #555;
    }
    .tab-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }
    .tab-button {
        padding: 8px 16px;
        background: #e9ecef;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease;
    }
    .tab-button.active {
        background: #007bff;
        color: #fff;
    }
    .tab-button:hover {
        background: #ced4da;
    }
    .notification-badge {
        background: #dc3545;
        color: #fff;
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 12px;
        margin-left: 5px;
    }
    .tab {
        display: none;
    }
    .tab.active {
        display: block;
    }
    .notifications-list {
        list-style: none;
        padding: 0;
    }
    .notification-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .notification-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .notification-item.unread {
        background: #e7f3ff;
        border-left: 4px solid #007bff;
    }
    .notification-item strong {
        color: #007bff;
    }
    .notification-item small {
        display: block;
        color: #555;
        font-size: 12px;
        margin-top: 5px;
    }
    .new-label {
        color: #dc3545;
        font-weight: bold;
        margin-left: 5px;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        position: relative;
        animation: slideIn 0.3s ease;
    }
    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        color: #888;
        cursor: pointer;
    }
    .modal-close:hover {
        color: #dc3545;
    }
    .notification-header-detail {
        font-size: 22px;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 15px;
    }
    .notification-details p {
        margin: 10px 0;
        font-size: 14px;
        color: #444;
    }
    .notification-text {
        font-style: italic;
        font-size: 16px;
        padding: 10px;
        background: #e7f3ff;
        border: 1px dashed #007bff;
        border-radius: 8px;
    }
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    .button-group button {
        padding: 10px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
    }
    .reply-button {
        background: #28a745;
        color: #fff;
    }
    .reply-button:hover {
        background: #218838;
    }
    .delete-button {
        background: #dc3545;
        color: #fff;
    }
    .delete-button:hover {
        background: #c82333;
    }
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
        .notifications-wrapper {
            margin: 10px;
            padding: 15px;
        }
        .tab-buttons {
            flex-direction: column;
            gap: 10px;
        }
        .button-group {
            flex-direction: column;
        }
        .button-group button {
            width: 100%;
        }
    }
</style>

<div class="notifications-wrapper">
    <div class="notifications-header">Уведомления</div>

    <form action="{% url 'toggle_notifications' %}" method="POST" class="notification-form">
        {% csrf_token %}
        <label>
            <input type="checkbox" name="receive_notifications" onchange="this.form.submit()"
                   {% if request.user.profile.receive_notifications %}checked{% endif %}>
            Получать уведомления
        </label>
    </form>

    <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab(event, 'incoming')">
            Входящие
            <span class="notification-badge" {% if unread_notifications_count == 0 %}style="display:none;"{% endif %}>
                {{ unread_notifications_count }}
            </span>
        </button>
        <button class="tab-button" onclick="openTab(event, 'sent')">Мои уведомления</button>
    </div>

    <div id="incoming" class="tab active">
        <ul class="notifications-list">
            {% for notif in received_notifications %}
                <li class="notification-item {% if not notif.is_read %}unread{% endif %}"
                    data-id="{{ notif.id }}"
                    onclick="openModal('{{ notif.id }}')">
                    <div>{{ notif.text|truncatechars:50 }}</div>
                    {% if not notif.is_read %}<span class="new-label">(Новое)</span>{% endif %}
                    <small>Отправитель: {{ notif.sender.profile.full_name|default:notif.sender.username }}</small>
                    <small>Дата: {{ notif.timestamp }}</small>
                </li>
            {% empty %}
                <p>Уведомлений нет</p>
            {% endfor %}
        </ul>
    </div>

    <div id="sent" class="tab">
        <ul class="notifications-list">
            {% for notif in sent_notifications %}
                <li class="notification-item"
                    data-id="{{ notif.id }}"
                    onclick="openModal('{{ notif.id }}')">
                    <div>{{ notif.text|truncatechars:50 }}</div>
                    <small>Дата: {{ notif.timestamp }}</small>
                </li>
            {% empty %}
                <p>Уведомлений нет</p>
            {% endfor %}
        </ul>
    </div>

    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">×</span>
            <div class="notification-header-detail">Детали уведомления</div>
            <div class="notification-details" id="modal-body">
                <!-- Содержимое будет заполнено через JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('notification-modal');
    const modalBody = document.getElementById('modal-body');

    function openModal(notifId) {
        const item = document.querySelector(`.notification-item[data-id="${notifId}"]`);
        const isSent = item.closest('#sent');
        const replyUrl = `/notifications/${notifId}/reply/`;
        const deleteUrl = `/notifications/${notifId}/delete/`;
        let content = '';

        // Получаем данные уведомления из атрибутов или контекста
        {% for notif in received_notifications %}
            if (notifId === '{{ notif.id }}' && !isSent) {
                content = `
                    <p><strong>Отправитель:</strong> {{ notif.sender.profile.full_name|default:notif.sender.username }}</p>
                    <p><strong>Телефон:</strong> {{ notif.sender.profile.phone|default:'Не указан' }}</p>
                    <p><strong>Мастерская:</strong> {{ notif.sender.profile.workshop_name|default:'Не указана' }}</p>
                    <p><strong>Текст:</strong></p>
                    <div class="notification-text">{{ notif.text }}</div>
                    <p><strong>Дата:</strong> {{ notif.timestamp }}</p>
                    <div class="button-group">
                        <form action="${replyUrl}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="reply-button">Ответить</button>
                        </form>
                        <form action="${deleteUrl}" method="post" onsubmit="return confirm('Удалить это уведомление?');">
                            {% csrf_token %}
                            <button type="submit" class="delete-button">Удалить</button>
                        </form>
                    </div>
                `;
                {% if not notif.is_read %}
                    markAsRead(notifId, item);
                {% endif %}
            }
        {% endfor %}
        {% for notif in sent_notifications %}
            if (notifId === '{{ notif.id }}' && isSent) {
                content = `
                    <p><strong>Текст:</strong></p>
                    <div class="notification-text">{{ notif.text }}</div>
                    <p><strong>Дата:</strong> {{ notif.timestamp }}</p>
                    <div class="button-group">
                        <form action="${deleteUrl}" method="post" onsubmit="return confirm('Удалить это уведомление?');">
                            {% csrf_token %}
                            <button type="submit" class="delete-button">Удалить</button>
                        </form>
                    </div>
                `;
            }
        {% endfor %}

        modalBody.innerHTML = content;
        modal.style.display = 'flex';
    }

    function markAsRead(notifId, item) {
        fetch(`/notifications/${notifId}/mark_as_read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ notification_id: notifId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                item.classList.remove('unread');
                const newLabel = item.querySelector('.new-label');
                if (newLabel) newLabel.remove();
                updateBadgeCount();
            }
        })
        .catch(error => console.error('Ошибка:', error));
    }

    function updateBadgeCount() {
        const unreadCount = document.querySelectorAll('.notification-item.unread').length;
        const badge = document.querySelector('.notification-badge');
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    window.onclick = (event) => {
        if (event.target === modal) closeModal();
    };

    document.addEventListener("DOMContentLoaded", function () {
        const activeTab = sessionStorage.getItem("activeTab") || 'incoming';
        openTab(null, activeTab);
        updateBadgeCount();
    });

    function openTab(evt, tabName) {
        const tabs = document.getElementsByClassName("tab");
        const buttons = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tabs.length; i++) tabs[i].style.display = "none";
        for (let i = 0; i < buttons.length; i++) buttons[i].classList.remove("active");
        document.getElementById(tabName).style.display = "block";
        if (evt) {
            evt.currentTarget.classList.add("active");
            sessionStorage.setItem("activeTab", tabName);
        } else {
            document.querySelector(`.tab-button[onclick*="${tabName}"]`).classList.add("active");
        }
    }
</script>
{% endblock %}