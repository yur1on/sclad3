{% extends 'warehouse/base.html' %}
{% load device_filters %}

{% block title %}Информация о запчасти{% endblock %}
{% load static %}
{% block content %}
<style>
    body {
        font-family: 'Roboto', sans-serif;
    }

    .card {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        padding: 10px;
    }

    .card-header {
        font-size: 22px;
        font-weight: 700;
        color: #007bff;
        background: #fff;
        border-bottom: 1px solid #ddd;
        padding: 15px;
        border-radius: 15px 15px 0 0;
    }

    .card-body {
        padding: 15px;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
    }

    .table th,
    .table td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    .btn {
        padding: 6px 10px;
        border-radius: 10px;
        font-size: 14px;
        transition: background-color 0.3s ease;
    }

    .btn-primary {
        background-color: #007bff;
        border: none;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    .btn-outline-primary {
        border: 1px solid #007bff;
        color: #007bff;
    }

    .btn-outline-primary:hover {
        background-color: #007bff;
        color: #fff;
    }

    .btn-outline-secondary {
        border: 1px solid #6c757d;
        color: #6c757d;
    }

    .btn-outline-secondary:hover {
        background-color: #6c757d;
        color: #fff;
    }

    .carousel-inner img {
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .img-thumbnail {
        border-radius: 8px;
        border: 1px solid #ddd;
        transition: transform 0.2s ease;
    }

    .img-thumbnail:hover {
        transform: scale(1.1);
    }

    .modal-content {
        border-radius: 15px;
    }

    .notification-chat {
        background: #fff3cd;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #ffeeba;
        margin-bottom: 15px;
        font-size: 14px;
    }
</style>

<!-- Верхняя часть с информацией о запчасти -->
<div class="row mb-3">
    <div class="card">
        <div class="card-body">
            <h4><strong>{{ part.part_type }}</strong> для {{ part.device|device_declension }} {{ part.brand }} {{ part.model }}</h4>
        </div>
    </div>
</div>

<!-- Основной блок с описанием и фото -->
<div class="row">
    <!-- Описание и информация о пользователе -->
    <div class="col-md-6">
        <div class="card">
            <table class="table">
                <tr>
                    <th>Количество</th>
                    <td>{{ part.quantity }}</td>
                </tr>
                <tr>
                    <th>Цена</th>
                    <td>{{ part.price }} бел. руб.</td>
                </tr>
                {% if part.color %}
                    <tr>
                        <th>Цвет</th>
                        <td>{{ part.color }}</td>
                    </tr>
                {% endif %}
                <tr>
                    <th>Дата добавления</th>
                    <td>{{ part.created_at|date:"d.m.Y" }}</td>
                </tr>
                <tr>
                    <th>Примечание</th>
                    <td>{{ part.note|default:"Нет примечаний" }}</td>
                </tr>
            </table>
            <div class="btn-group">
                <a href="{% url 'toggle_bookmark' part.id %}" class="btn btn-outline-primary">
                    {% if is_bookmarked %}Удалить из закладок{% else %}Добавить в закладки{% endif %}
                </a>
                <a href="{% url 'user_parts' part.user.id %}" class="btn btn-outline-secondary">Все запчасти продавца</a>
            </div>
        </div>

        <!-- Информация о продавце -->
        <div class="card mt-3">
            <div class="card-header">Информация о продавце</div>
            <div class="card-body">
                <table class="table">
                    <tr>
                        <th>Имя</th>
                        <td>{{ part.user.profile.full_name|default:"Не указано" }}</td>
                    </tr>
                    <tr>
                        <th>Мастерская</th>
                        <td>{{ part.user.profile.workshop_name|default:"Частное лицо" }}</td>
                    </tr>
                    <tr>
                        <th>Город</th>
                        <td>{{ part.user.profile.city }}</td>
                    </tr>
                    <tr>
                        <th>Телефон</th>
                        <td>{{ part.user.profile.phone }}</td>
                    </tr>
                    <tr>
                        <th>Средний рейтинг</th>
                        <td>{{ part.user.profile.average_rating }}</td>
                    </tr>
                    <tr>
                        <th>Дата регистрации</th>
                        <td>{{ part.user.date_joined|date:"d.m.Y" }}</td>
                    </tr>
                    <tr>
                        <th>Способ доставки</th>
                        <td>{{ part.user.profile.delivery_methods|default:"Не указан" }}</td>
                    </tr>
                </table>
                <div class="text-center mt-3">
                    <a href="{% url 'add_review' part.user.id %}" class="btn btn-outline-primary">Оставить отзыв</a>
                    <a href="{% url 'view_reviews' part.user.id %}" class="btn btn-outline-secondary">Отзывы продавца</a>
                    {% if part.user != request.user %}
                        <a href="{% url 'start_chat' part.id part.user.id %}" class="btn btn-primary">Написать продавцу</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Фото запчасти -->
    <div class="col-md-6 text-center">
        {% if part.images.all %}
            <!-- Карусель изображений -->
            <div id="partImagesCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for image in part.images.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img id="mainImage" src="{{ image.image.url }}" alt="Изображение запчасти" class="img-fluid" data-bs-toggle="modal" data-bs-target="#imageModal" onclick="openModal({{ forloop.counter0 }})">
                        </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#partImagesCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#partImagesCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>
            </div>

            <!-- Миниатюры изображений -->
            <div class="row mt-3">
                <div class="col-12 d-flex justify-content-center">
                    {% for image in part.images.all %}
                        <img src="{{ image.image.url }}" alt="Миниатюра" class="img-thumbnail mx-1" style="width: 100px; height: 100px;" onclick="selectThumbnail({{ forloop.counter0 }})">
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <p>Нет изображений</p>
        {% endif %}
    </div>
</div>

<!-- Модальное окно для просмотра изображений -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <img id="modalImage" src="" class="img-fluid" alt="Изображение запчасти">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="changeImage(-1)">Предыдущее</button>
                <button type="button" class="btn btn-secondary" onclick="changeImage(1)">Следующее</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentImageIndex = 0;
    const imageUrls = [
        {% for image in part.images.all %}
            "{{ image.image.url }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    function openModal(index) {
        currentImageIndex = index;
        document.getElementById('modalImage').src = imageUrls[currentImageIndex];
    }

    function changeImage(direction) {
        currentImageIndex += direction;
        if (currentImageIndex < 0) {
            currentImageIndex = imageUrls.length - 1;
        } else if (currentImageIndex >= imageUrls.length) {
            currentImageIndex = 0;
        }
        document.getElementById('modalImage').src = imageUrls[currentImageIndex];
    }

    function selectThumbnail(index) {
        document.getElementById('mainImage').src = imageUrls[index];
    }
</script>

{% endblock %}