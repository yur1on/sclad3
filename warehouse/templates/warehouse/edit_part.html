{% extends 'warehouse/base.html' %}
{% block title %}Редактировать запчасть{% endblock %}
{% block content %}
{% load static %}
<style>
    .image-item {
        display: inline-block;
        margin: 5px;
    }
    .image-item img {
        max-width: 100px;
    }
    .add-image {
        display: inline-block;
        margin: 5px;
        border: 1px dashed #ccc;
        padding: 10px;
        text-align: center;
        cursor: pointer;
    }
</style>

<div class="container">
    <h2>Редактировать запчасть</h2>

    <form method="post" enctype="multipart/form-data" id="edit-part-form">
        {% csrf_token %}
        <div class="form-group">
            <label for="device">Устройство</label>
            <input type="text" name="device" id="device" class="form-control" value="{{ part.device }}" required>
        </div>

        <div class="form-group">
            <label for="brand">Бренд</label>
            <input type="text" name="brand" id="brand" class="form-control" value="{{ part.brand }}" required>
        </div>

        <div class="form-group">
            <label for="model">Модель</label>
            <input type="text" name="model" id="model" class="form-control" value="{{ part.model }}" required>
        </div>

        <div class="form-group">
            <label for="part_type">Тип запчасти</label>
            <input type="text" name="part_type" id="part_type" class="form-control" value="{{ part.part_type }}" required>
        </div>

        <div class="form-group">
            <label for="color">Цвет</label>
            <input type="text" name="color" id="color" class="form-control" value="{{ part.color }}">
        </div>

        <div class="form-group">
            <label for="quantity">Количество</label>
            <input type="number" name="quantity" id="quantity" class="form-control" value="{{ part.quantity }}" required>
        </div>

        <div class="form-group">
            <label for="price">Цена</label>
            <input type="number" name="price" id="price" class="form-control" value="{{ part.price }}" required>
        </div>

        <div class="form-group">
            <label>Изображения (можно загрузить до 5)</label>
            <div class="image-container" id="image-container">
                {% for image in part.images.all %}
                    <div class="image-item" data-image-id="{{ image.id }}">
                        <img src="{{ image.image.url }}" alt="Image">
                        <button type="button" class="btn btn-danger btn-sm delete-image" data-image-id="{{ image.id }}">
                            Удалить
                        </button>
                    </div>
                {% endfor %}
                <!-- Кнопка добавления фото будет динамически генерироваться через JS -->
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Сохранить изменения</button>
        <a href="{% url 'warehouse' %}" class="btn btn-secondary">Назад</a>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
const maxImages = 5;

function updateAddImageButton() {
    const currentImagesCount = $('#image-container .image-item').length;
    $('.add-image').remove(); // Удаляем все кнопки перед обновлением

    if (currentImagesCount < maxImages) {
        const remainingSlots = maxImages - currentImagesCount;

        for (let i = 1; i <= remainingSlots; i++) {
            const buttonId = currentImagesCount + i;
            $('#image-container').append(`
                <div class="add-image" onclick="document.getElementById('images-${buttonId}').click();">
                    <input type="file" name="images" id="images-${buttonId}" class="d-none" onchange="uploadImage(this);">
                    Добавить фото
                </div>
            `);
        }
    }
}

function uploadImage(input) {
    const currentImagesCount = $('#image-container .image-item').length;

    if (currentImagesCount >= maxImages) {
        alert('Вы можете загрузить не более 5 изображений.');
        return;
    }

    const formData = new FormData();
    formData.append('image', input.files[0]);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('part_id', {{ part.id }});

    $.ajax({
        url: '/add-image/',
        method: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function(response) {
            if (response.status === 'success') {
                response.images.forEach(image => {
                    const newImageItem = `
                        <div class="image-item" data-image-id="${image.id}">
                            <img src="${image.url}" alt="Image">
                            <button type="button" class="btn btn-danger btn-sm delete-image" data-image-id="${image.id}">
                                Удалить
                            </button>
                        </div>
                    `;
                    $('#image-container').append(newImageItem);
                });
                updateAddImageButton();
            } else {
                alert('Ошибка при добавлении изображения: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('Ошибка AJAX запроса:', error);
            alert('Произошла ошибка при выполнении запроса. Пожалуйста, попробуйте снова.');
        }
    });
}

$(document).on('click', '.delete-image', function () {
    const imageId = $(this).data('image-id');
    const imageItem = $(this).closest('.image-item');

    if (confirm('Вы уверены, что хотите удалить это изображение?')) {
        $.ajax({
            url: '/delete-image/' + imageId + '/',
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function (response) {
                if (response.status === 'success') {
                    imageItem.remove();
                    updateAddImageButton();
                } else {
                    alert('Ошибка при удалении изображения: ' + response.message);
                }
            },
            error: function (xhr, status, error) {
                console.error('Ошибка AJAX запроса:', error);
                alert('Произошла ошибка при выполнении запроса. Пожалуйста, попробуйте снова.');
            }
        });
    }
});

$(document).ready(function() {
    updateAddImageButton(); // Инициализация кнопок при загрузке страницы
});
</script>

{% endblock %}
