{% extends 'warehouse/base.html' %}

{% block title %}Редактировать запчасть{% endblock %}

{% block content %}
{% load static %}

<div class="container mt-3 mb-4">
    <h2 class="mb-3 text-center">Редактировать запчасть</h2>

    <form method="post" enctype="multipart/form-data" id="edit-part-form">
        {% csrf_token %}

                <!-- Номер запчасти (readonly) -->
        <div class="form-group mb-3 row">
            <label for="part_number" class="col-sm-2 col-form-label">Номер запчасти:</label>
            <div class="col-sm-8">
                <input type="text" name="part_number" id="part_number" class="form-control shadow-sm" value="{{ part.part_number }}" readonly>
            </div>
        </div>

        <!-- Устройство (readonly) -->
        <div class="form-group mb-3 row">
            <label for="device" class="col-sm-2 col-form-label">Устройство:</label>
            <div class="col-sm-8">
                <input type="text" name="device" id="device" class="form-control shadow-sm" value="{{ part.device }}" readonly>
            </div>
        </div>

        <!-- Бренд (readonly) -->
        <div class="form-group mb-3 row">
            <label for="brand" class="col-sm-2 col-form-label">Бренд:</label>
            <div class="col-sm-8">
                <input type="text" name="brand" id="brand" class="form-control shadow-sm" value="{{ part.brand }}" readonly>
            </div>
        </div>

        <!-- Модель (readonly) -->
        <div class="form-group mb-3 row">
            <label for="model" class="col-sm-2 col-form-label">Модель:</label>
            <div class="col-sm-8">
                <input type="text" name="model" id="model" class="form-control shadow-sm" value="{{ part.model }}" readonly>
            </div>
        </div>

        <!-- Тип запчасти (readonly) -->
        <div class="form-group mb-3 row">
            <label for="part_type" class="col-sm-2 col-form-label">Тип запчасти:</label>
            <div class="col-sm-8">
                <input type="text" name="part_type" id="part_type" class="form-control shadow-sm" value="{{ part.part_type }}" readonly>
            </div>
        </div>



        <!-- Цвет (readonly) -->
        <div class="form-group mb-3 row">
            <label for="color" class="col-sm-2 col-form-label">Цвет:</label>
            <div class="col-sm-8">
                <input type="text" name="color" id="color" class="form-control shadow-sm" value="{{ part.color|default:"не выбран" }}" readonly>
            </div>
        </div>

        <!-- Количество -->
        <div class="form-group mb-3 row">
            <label for="quantity" class="col-sm-2 col-form-label">Количество:</label>
            <div class="col-sm-8">
                <input type="number" name="quantity" id="quantity" class="form-control shadow-sm" value="{{ part.quantity }}" required>
            </div>
        </div>

        <!-- Цена -->
        <div class="form-group mb-3 row">
            <label for="price" class="col-sm-2 col-form-label">Цена:</label>
            <div class="col-sm-8">
                <input type="number" name="price" id="price" class="form-control shadow-sm" value="{{ part.price }}" required>
            </div>
        </div>

        <!-- Изображения -->
        <div class="form-group mb-4 row">
            <label class="col-sm-2 col-form-label">Изображения:</label>
            <div class="col-sm-8 d-flex flex-wrap gap-2">
                {% for image in part.images.all %}
                <div class="position-relative">
                    <img src="{{ image.image.url }}" alt="Image" class="img-thumbnail" style="width: 90px; height: 90px; object-fit: cover;">
                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 delete-image" data-image-id="{{ image.id }}">&times;</button>
                </div>
                {% endfor %}
                {% if part.images.count < 5 %}
                <div class="add-image" onclick="document.getElementById('new-image-input').click();">
                    <input type="file" id="new-image-input" class="d-none" onchange="uploadImage(this);" accept="image/*">
                    <div class="add-icon">+</div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-primary shadow-sm">Сохранить изменения</button>
            <a href="{% url 'warehouse' %}" class="btn btn-secondary shadow-sm">Назад</a>
        </div>
    </form>
</div>

<!-- Скрипты для работы с изображениями -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function uploadImage(input) {
    const formData = new FormData();
    formData.append('image', input.files[0]);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('part_id', {{ part.id }});

    $.ajax({
        url: '/add-image/',
        method: 'POST',
        data: formData,
        contentType: false,
        processData: false,
        success: function(response) {
            if (response.status === 'success') {
                location.reload();
            } else {
                alert('Ошибка при добавлении изображения: ' + response.message);
            }
        },
        error: function() {
            alert('Произошла ошибка при загрузке изображения.');
        }
    });
}

$(document).on('click', '.delete-image', function () {
    const imageId = $(this).data('image-id');
    if (confirm('Вы уверены, что хотите удалить это изображение?')) {
        $.ajax({
            url: '/delete-image/' + imageId + '/',
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    location.reload();
                } else {
                    alert('Ошибка при удалении изображения: ' + response.message);
                }
            },
            error: function() {
                alert('Произошла ошибка при удалении изображения.');
            }
        });
    }
});
</script>
{% endblock %}
