{% extends 'warehouse/base.html' %}
{% block title %}–°–∫–ª–∞–¥{% endblock %}
{% block content %}
{% load static %}
<div class="container my-4">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">–í–∞—à–∏ –∑–∞–ø—á–∞—Å—Ç–∏</h2>
        <div>
            <a href="{% url 'add_part' %}" class="btn btn-success me-2">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</a>
            <a href="{% url 'export_excel' %}" class="btn btn-info">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
    <div class="mb-4">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="device" class="form-label">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</label>
                <input type="text" list="devices" name="q" id="device" class="form-control" placeholder="–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" value="{{ query|default_if_none:'' }}">
                <datalist id="devices">
                    <option value="–¢–µ–ª–µ—Ñ–æ–Ω">
                    <option value="–ü–ª–∞–Ω—à–µ—Ç">
                    <option value="–ù–æ—É—Ç–±—É–∫">
                    <option value="–°–º–∞—Ä—Ç-—á–∞—Å—ã">
                </datalist>
            </div>

            <div class="col-md-2">
                <label for="brand" class="form-label">–ë—Ä–µ–Ω–¥</label>
                <input list="brands" name="brand" id="brand" class="form-control" placeholder="–ë—Ä–µ–Ω–¥" value="{{ brand|default_if_none:'' }}">
                <datalist id="brands"></datalist>
            </div>

            <div class="col-md-2">
                <label for="model" class="form-label">–ú–æ–¥–µ–ª—å</label>
                <input list="models" name="model" id="model" class="form-control" placeholder="–ú–æ–¥–µ–ª—å" value="{{ model|default_if_none:'' }}">
                <datalist id="models"></datalist>
            </div>

            <div class="col-md-3">
                <label for="part_type" class="form-label">–¢–∏–ø –∑–∞–ø—á–∞—Å—Ç–∏</label>
                <input list="part_types" name="part_type" id="part_type" class="form-control" placeholder="–¢–∏–ø –∑–∞–ø—á–∞—Å—Ç–∏" value="{{ part_type|default_if_none:'' }}">
                <datalist id="part_types"></datalist>
            </div>

            <div class="col-md-2 d-grid align-items-end">
                <button type="submit" class="btn btn-primary">–ü–æ–∏—Å–∫</button>
            </div>
        </form>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞" -->
    <button id="show-devices-btn" class="btn btn-outline-primary mb-4">–ü–æ–∫–∞–∑–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</button>

    <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
    <button id="back-btn" class="btn btn-secondary mb-4" style="display: none;">–ù–∞–∑–∞–¥</button>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –±—Ä–µ–Ω–¥–æ–≤ -->
    <div id="device-buttons-container" class="mb-4" style="display: none;">
        <div id="device-buttons" class="mb-3"></div>
        <div id="brand-buttons"></div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π -->
    <div id="parts-table-container" class="table-responsive">
        <table id="parts-table" class="table table-striped table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th onclick="sortTable(0)">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                    <th onclick="sortTable(1)">–ë—Ä–µ–Ω–¥</th>
                    <th onclick="sortTable(2)">–ú–æ–¥–µ–ª—å</th>
                    <th onclick="sortTable(3)">–¢–∏–ø –∑–∞–ø—á–∞—Å—Ç–∏</th>
                    <th onclick="sortTable(4)">–¶–≤–µ—Ç</th>
                    <th onclick="sortTable(5)">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th onclick="sortTable(6)">–¶–µ–Ω–∞</th>
                    <th>–§–æ—Ç–æ</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for part in parts %}
                <tr>
                    <td>{{ part.device }}</td>
                    <td>{{ part.brand }}</td>
                    <td>{{ part.model }}</td>
                    <td>{{ part.part_type }}</td>
                    <td>{{ part.color|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</td>
                    <td>{{ part.quantity }}</td>
                    <td>{{ part.price }}</td>
                    <td>
                        {% if part.images.all %}
                        <div class="d-flex">
                            {% for image in part.images.all %}
                            <a href="{{ image.image.url }}" target="_blank" class="img-link">
                                <img src="{{ image.image.url }}" alt="{{ part.model }}" class="img-thumbnail" style="max-width: 80px; max-height: 80px;">
                            </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        –ù–µ—Ç —Ñ–æ—Ç–æ
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'edit_part' part.id %}" class="btn btn-warning btn-sm mb-1" data-bs-toggle="tooltip" data-bs-placement="top" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                        <a href="{% url 'delete_part' part.id %}" class="btn btn-danger btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">–ó–∞–ø—á–∞—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
let sortDirections = {};

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
function sortTable(columnIndex) {
    const table = document.getElementById("parts-table");
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.querySelectorAll("tr"));

    if (!sortDirections[columnIndex]) {
        sortDirections[columnIndex] = 'asc';
    } else {
        sortDirections[columnIndex] = sortDirections[columnIndex] === 'asc' ? 'desc' : 'asc';
    }

    rows.sort((a, b) => {
        const aText = a.cells[columnIndex].textContent.trim().toLowerCase();
        const bText = b.cells[columnIndex].textContent.trim().toLowerCase();
        return (aText < bText ? -1 : aText > bText ? 1 : 0) * (sortDirections[columnIndex] === 'asc' ? 1 : -1);
    });

    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    updateSortIndicators(columnIndex);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
function updateSortIndicators(activeColumnIndex) {
    const headers = document.querySelectorAll("#parts-table thead th");
    headers.forEach((th, index) => {
        th.innerHTML = th.textContent.replace(' ‚ñ≤', '').replace(' ‚ñº', '');
        if (index === activeColumnIndex) {
            th.innerHTML += sortDirections[activeColumnIndex] === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        }
    });
}

// –°–≤—è–∑—å –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, –±—Ä–µ–Ω–¥–∞–º–∏ –∏ –º–æ–¥–µ–ª—è–º–∏
const deviceBrandModelMap = {
    '–¢–µ–ª–µ—Ñ–æ–Ω': {
        'Samsung': ['a10', 'a20', 'a30', 's10'],
        'Huawei': ['p10', 'p20', 'honor 50'],
        'Xiaomi': ['redmi 5', 'redmi 6', 'redmi 7'],
        'Realme': ['realme 8', 'realme 6', 'realme 7', 'realme x2'],
        'LG': ['LG G7', 'LG V40', 'LG K50']
    },
    '–ü–ª–∞–Ω—à–µ—Ç': {
        'Samsung': ['tab s3', 'tab s4', 'tab a'],
        'Huawei': ['mediapad t5', 'mediapad m5'],
        'Xiaomi': ['mi pad 4', 'mi pad 5'],
        'Apple': ['iPad Air', 'iPad Pro', 'iPad Mini']
    },
    '–ù–æ—É—Ç–±—É–∫': {
        'Dell': ['XPS 13', 'XPS 15', 'Inspiron'],
        'HP': ['Spectre x360', 'Envy 13', 'Pavilion 15'],
        'Lenovo': ['ThinkPad X1', 'Yoga C930', 'Legion Y540'],
        'Asus': ['ZenBook', 'ROG Strix', 'VivoBook']
    },
    '–°–º–∞—Ä—Ç-—á–∞—Å—ã': {
        'Apple': ['Series 3', 'Series 4', 'Series 5'],
        'Samsung': ['Galaxy Watch', 'Galaxy Watch Active', 'Gear S3'],
        'Xiaomi': ['Amazfit', 'Mi Band 4', 'Mi Band 5']
    }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
document.getElementById("show-devices-btn").addEventListener("click", function() {
    const deviceButtonsContainer = document.getElementById("device-buttons-container");
    deviceButtonsContainer.style.display = "block";
    this.style.display = "none";
    document.getElementById("back-btn").style.display = "inline-block";

    const deviceButtons = document.getElementById("device-buttons");
    deviceButtons.innerHTML = '';

    Object.keys(deviceBrandModelMap).forEach(device => {
        const button = document.createElement("button");
        button.textContent = device;
        button.className = "btn btn-outline-primary me-2 mb-2 device-btn";
        button.addEventListener("click", () => showBrandButtons(device));
        deviceButtons.appendChild(button);
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –±—Ä–µ–Ω–¥–æ–≤
function showBrandButtons(device) {
    const brandButtonsContainer = document.getElementById("brand-buttons");
    brandButtonsContainer.innerHTML = '';
    const brands = deviceBrandModelMap[device];

    Object.keys(brands).forEach(brand => {
        const button = document.createElement("button");
        button.textContent = brand;
        button.className = "btn btn-outline-primary me-2 mb-2 brand-btn";
        button.addEventListener("click", () => showPartsTable(device, brand));
        brandButtonsContainer.appendChild(button);
    });

    // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    highlightSelectedButton('.device-btn', device);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏
function highlightSelectedButton(selector, text) {
    const buttons = document.querySelectorAll(selector);
    buttons.forEach(button => {
        if (button.textContent === text) {
            button.classList.add('btn-primary');
            button.classList.remove('btn-outline-primary');
        } else {
            button.classList.add('btn-outline-primary');
            button.classList.remove('btn-primary');
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å –∑–∞–ø—á–∞—Å—Ç—è–º–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –±—Ä–µ–Ω–¥–∞
function showPartsTable(device, brand) {
    const partsTableContainer = document.getElementById("parts-table-container");
    const rows = partsTableContainer.querySelectorAll("tbody tr");

    rows.forEach(row => {
        const deviceCell = row.cells[0].textContent.trim();
        const brandCell = row.cells[1].textContent.trim();
        if (deviceCell === device && brandCell === brand) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±—Ä–µ–Ω–¥
    highlightSelectedButton('.brand-btn', brand);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –≤—ã–±–æ—Ä—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤
document.getElementById("back-btn").addEventListener("click", function() {
    document.getElementById("device-buttons-container").style.display = "none";
    document.getElementById("show-devices-btn").style.display = "inline-block";
    this.style.display = "none";
});
</script>

<style>
/* –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω–∏–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}
</style>

{% endblock %}
